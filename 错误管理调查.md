

---

## Provider 连接状态管理分析

### 1. Provider 架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Provider 层                                 │
│                                                                      │
│  ┌──────────────────┐    ┌──────────────────┐                       │
│  │  CopilotProvider │    │  OllamaProvider  │                       │
│  │                  │    │                  │                       │
│  │  TokenManager    │    │  httpClient      │                       │
│  │  (GitHub Token)  │    │  (11434 端口)    │                       │
│  └────────┬─────────┘    └────────┬─────────┘                       │
│           │                       │                                  │
│           ▼                       ▼                                  │
│  ┌─────────────────────────────────────────┐                        │
│  │              Pool / MultiPool            │                        │
│  │  - 模型缓存                              │                        │
│  │  - 按需创建 Provider                     │                        │
│  │  - 场景默认模型                          │                        │
│  └─────────────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────┘
```

### 2. 错误类型定义

#### Copilot Provider (token.go)
```go
var (
    ErrUnauthorized       = errors.New("unauthorized: invalid or expired GitHub token")
    ErrRateLimited        = errors.New("rate limited: too many requests")
    ErrServiceUnavailable = errors.New("service unavailable")
    ErrTokenExpired       = errors.New("copilot token expired")
)
```

#### Ollama Provider (ollama.go)
```go
var (
    ErrConnectionFailed = errors.New("failed to connect to Ollama server")
    ErrModelNotFound    = errors.New("model not found")
    ErrInvalidResponse  = errors.New("invalid response from Ollama")
    ErrRequestTimeout   = errors.New("request timeout")
)
```

### 3. 现有机制分析

#### 3.1 后端机制

| 机制 | Copilot | Ollama | 说明 |
|------|---------|--------|------|
| **自动重试** | ✅ 3次，指数退避 | ❌ 无 | Copilot 有重试，Ollama 没有 |
| **Token 刷新** | ✅ 自动刷新 | N/A | 带 5 分钟提前量 |
| **Token 失效处理** | ✅ `Invalidate()` | N/A | 401/403 时清除缓存 |
| **连接超时** | 5 分钟 | 配置可变 | 长任务需要 |
| **状态追踪** | ❌ 无状态字段 | ❌ 无状态字段 | 仅在请求时检测 |
| **健康检查** | ❌ 无 | ❌ 无 | `HandleListModels` 标注 "TODO: Add health check" |

#### 3.2 API 层 - routes.go

```go
// HandleListModels 中的 Provider 状态
providerStatuses = append(providerStatuses, ProviderStatus{
    Name:       providerName,
    Enabled:    true,
    Available:  true, // TODO: Add health check  <-- 硬编码为 true!
    ModelCount: modelCount,
})
```

**问题：** `Available` 字段永远为 `true`，没有实际检测！

#### 3.3 前端显示 - SettingsPage.tsx

```tsx
<Badge 
  status={status.available ? 'success' : 'error'} 
  text={status.available ? '已连接' : '未连接'} 
/>
{status.error && (
  <Text type="danger">{status.error}</Text>
)}
```

前端有 UI，但后端始终返回 `available: true`，所以用户永远看到"已连接"。

### 4. 问题总结

| 问题类型 | 描述 | 影响 |
|---------|------|------|
| **状态不可见** | Provider 连接状态始终显示"已连接" | 用户无法知道真实状态 |
| **错误不透传** | 认证失败、Rate Limit 等错误仅在请求时出现 | 用户无法提前知道问题 |
| **无健康检查** | 没有主动探测 Provider 可用性 | 只有发消息才知道断了 |
| **Ollama 无重试** | Ollama 失败即失败 | 网络抖动直接报错 |
| **错误信息模糊** | SSE 中断时提示不清晰 | 用户不知道是 Token 问题还是网络问题 |
| **无手动恢复** | 认证失败后只能重启或等待 | 无法主动重新认证 |

### 5. 错误场景分析

#### 5.1 Copilot Token 过期

```
时间线:
  T0: Token 获取成功
  T1: Token 临近过期（<5分钟）
  T2: 下次请求自动刷新
  
问题: 
  - 如果 GitHub API 不可用，刷新失败
  - 用户发消息时才发现，收到模糊的错误
```

#### 5.2 Ollama 服务未运行

```
用户操作: 选择 Ollama 模型发送消息
实际结果: 
  1. 请求超时或连接拒绝
  2. 返回 "failed to connect to Ollama server"
  3. 用户需要自己排查 Ollama 服务状态

期望结果:
  - 模型列表中 Ollama 模型标记为不可用
  - 切换模型时提示 Ollama 服务未启动
```

#### 5.3 Rate Limit

```
当前行为:
  1. Copilot 返回 429
  2. 自动重试 3 次（指数退避）
  3. 重试失败后返回 "max retries exceeded: rate limited"
  
问题:
  - 用户不知道还有多久可以重试
  - 没有配额使用统计显示
```

### 6. 改进建议

#### 6.1 后端改进

**1. 添加 Provider 状态接口**

```go
// ProviderState 表示 Provider 的实时状态
type ProviderState struct {
    Name        string    `json:"name"`
    Status      string    `json:"status"`      // connected, disconnected, error, rate_limited
    LastCheck   time.Time `json:"last_check"`
    LastError   string    `json:"last_error,omitempty"`
    RetryAfter  int       `json:"retry_after,omitempty"` // 秒数，用于 rate limit
}

// GET /api/v1/providers/status
func (r *Router) HandleProviderStatus(w http.ResponseWriter, req *http.Request) {
    // 主动检测各 Provider 状态
}
```

**2. Copilot Token 状态暴露**

```go
// TokenManager 添加状态方法
func (tm *TokenManager) GetStatus() TokenStatus {
    tm.mu.Lock()
    defer tm.mu.Unlock()
    
    if tm.cache == nil {
        return TokenStatus{Valid: false, Message: "未认证"}
    }
    
    remaining := time.Until(tm.cache.ExpiresAt)
    if remaining < TokenRefreshMargin {
        return TokenStatus{Valid: true, Warning: "即将过期", ExpiresIn: remaining}
    }
    
    return TokenStatus{Valid: true, ExpiresIn: remaining}
}
```

**3. Ollama 健康检查**

```go
// 添加 Ping 方法
func (p *OllamaProvider) Ping(ctx context.Context) error {
    ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
    defer cancel()
    
    resp, err := p.httpClient.Get(p.endpoint + "/api/tags")
    if err != nil {
        return ErrConnectionFailed
    }
    defer resp.Body.Close()
    
    if resp.StatusCode != http.StatusOK {
        return fmt.Errorf("ollama returned %d", resp.StatusCode)
    }
    return nil
}
```

**4. 错误分类增强**

```go
type ProviderError struct {
    Code      string `json:"code"`      // AUTH_FAILED, RATE_LIMITED, UNAVAILABLE, MODEL_NOT_FOUND
    Message   string `json:"message"`
    Provider  string `json:"provider"`
    Retryable bool   `json:"retryable"`
    RetryIn   int    `json:"retry_in,omitempty"` // 秒
}
```

#### 6.2 前端改进

**1. Provider 状态监控组件**

```tsx
// 定期轮询 Provider 状态
useEffect(() => {
  const checkStatus = async () => {
    const status = await api.getProviderStatus();
    setProviderStates(status);
  };
  
  checkStatus();
  const interval = setInterval(checkStatus, 30000); // 30秒一次
  return () => clearInterval(interval);
}, []);
```

**2. 错误恢复操作**

```tsx
{providerState.status === 'auth_failed' && (
  <Button onClick={handleReauth}>
    重新认证
  </Button>
)}

{providerState.status === 'rate_limited' && (
  <Countdown 
    value={Date.now() + providerState.retryAfter * 1000} 
    format="mm:ss 后可重试"
  />
)}

{providerState.status === 'unavailable' && providerState.name === 'ollama' && (
  <Button onClick={handleCheckOllama}>
    检查 Ollama 服务
  </Button>
)}
```

**3. Chat 页面 Provider 状态提示**

```tsx
// 在 ChatPage 顶部显示 Provider 状态
{currentProviderState?.status !== 'connected' && (
  <Alert
    type="warning"
    message={`${currentProvider} 当前不可用`}
    description={currentProviderState?.lastError}
    action={
      <Space>
        <Button size="small" onClick={handleSwitchProvider}>
          切换模型
        </Button>
        <Button size="small" type="primary" onClick={handleRetry}>
          重试
        </Button>
      </Space>
    }
  />
)}
```

### 7. 优先级建议

| 优先级 | 改进项 | 工作量 |
|-------|-------|-------|
| **P0** | 修复 `Available` 始终为 true 的问题 | 小 |
| **P0** | 添加 Ollama Ping 检测 | 小 |
| **P1** | 添加 `/api/v1/providers/status` 接口 | 中 |
| **P1** | 前端定期检测 Provider 状态 | 中 |
| **P1** | Chat 页面显示 Provider 告警 | 中 |
| **P2** | Copilot Token 状态暴露 | 小 |
| **P2** | Rate Limit 倒计时显示 | 小 |
| **P2** | Ollama Provider 添加重试机制 | 中 |

### 8. 与 MCP/Session 问题对比

| 维度 | MCP | Provider | Session/Stream |
|------|-----|----------|----------------|
| 状态字段 | ✅ `ConnectionState` | ❌ 无 | ❌ 无 |
| 状态可见性 | ❌ 不暴露给前端 | ❌ 假装可用 | ❌ 无指示器 |
| 错误处理 | ⚠️ 转为工具结果 | ⚠️ 转为 event error | ⚠️ 可能卡住 |
| 重试机制 | ❌ 无 | ⚠️ 仅 Copilot | ❌ 无 |
| 手动恢复 | ❌ 无 | ❌ 无 | ❌ 无 |

**结论**：Provider 层的问题与 MCP/Session 类似，但更隐蔽——因为 API 始终返回"可用"，用户根本不知道有问题，直到发消息失败。