# Runner é‡æ„è¿›åº¦æŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-20  
**åˆ†æ”¯**: `refactor/runner-modular`  
**çŠ¶æ€**: ğŸŸ¢ ç¬¬ä¸€é˜¶æ®µå®Œæˆï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## âœ… å·²å®Œæˆå·¥ä½œ

### é˜¶æ®µ 0: å‡†å¤‡å·¥ä½œ
- âœ… å»ºç«‹æµ‹è¯•åŸºçº¿ï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼‰
- âœ… åˆ›å»ºé‡æ„åˆ†æ”¯ `refactor/runner-modular`
- âœ… ä¿®å¤æµ‹è¯•é—®é¢˜ï¼ˆ`DefaultConfig` æµ‹è¯•ä¸å®ç°ä¸ä¸€è‡´ï¼‰

### é˜¶æ®µ 1: æ ¸å¿ƒæŠ½è±¡æå–

#### 1.1 Orchestrator åŸºç¡€æ¶æ„
**æ–‡ä»¶**: 
- `internal/runner/orchestrator/types.go` - ç±»å‹å®šä¹‰
- `internal/runner/orchestrator/base.go` - åŸºç¡€åè°ƒå™¨

**åŠŸèƒ½**:
- `Orchestrator` æ¥å£å®šä¹‰
- `RunRequest` è¯·æ±‚å°è£…
- `LoopState` çŠ¶æ€è·Ÿè¸ª
- `BaseOrchestrator` æä¾›å…±äº«åŠŸèƒ½ï¼ˆå‹ç¼©ã€é’©å­ã€èŠå¤©è¯·æ±‚æ„å»ºï¼‰

**æäº¤**: `553c793`

#### 1.2 MessageBuilder ç»„ä»¶
**æ–‡ä»¶**:
- `internal/runner/message/builder.go`

**åŠŸèƒ½**:
- `Builder` æ¥å£å®šä¹‰
- `StandardBuilder` å®ç°
- æ”¯æŒ SystemPrompt/Skills/ContextManager/Memory æ³¨å…¥
- å®Œæ•´çš„æ¶ˆæ¯æ„å»ºé€»è¾‘ï¼ˆä» `runner.buildMessages` æå–ï¼‰

**æäº¤**: `73f212e`

#### 1.3-2.1 StandardOrchestrator å®ç°
**æ–‡ä»¶**:
- `internal/runner/orchestrator/standard.go` (452 è¡Œ)

**åŠŸèƒ½**:
- å®Œæ•´çš„æ ‡å‡†å·¥å…·è°ƒç”¨å¾ªç¯
- æ¶ˆæ¯æ„å»ºï¼ˆä¸´æ—¶ä½¿ç”¨ legacy æ–¹æ³•ï¼Œåç»­é›†æˆ MessageBuilderï¼‰
- å†å²å‹ç¼©ï¼ˆé›†æˆ Compactorï¼‰
- LLM è°ƒç”¨ï¼ˆæ”¯æŒ Chat/Stream æ¨¡å¼åˆ‡æ¢ï¼‰
- å·¥å…·æ‰§è¡Œï¼ˆç®€åŒ–ç‰ˆï¼ŒåŒ…å«åŸºæœ¬çš„å‚æ•°è§£æå’Œæ‰§è¡Œï¼‰
- é‡è¯•é€»è¾‘ï¼š
  - ä¸Šä¸‹æ–‡çª—å£æº¢å‡ºé‡è¯•
  - ä¸´æ—¶é”™è¯¯æŒ‡æ•°é€€é¿é‡è¯•
- é’©å­é›†æˆï¼ˆsession_create, before_messageï¼‰
- çŠ¶æ€ç®¡ç†ï¼ˆiteration, errors, retry flagsï¼‰

**æäº¤**: `74172b0`

---

## ğŸ“Š é‡æ„æ•ˆæœ

### ä»£ç ç»„ç»‡
**å‰**:
- `runner.go`: 2397 è¡Œï¼Œ51 ä¸ªæ–¹æ³•ï¼Œæ‰€æœ‰é€»è¾‘æ··åœ¨ä¸€èµ·

**åï¼ˆåˆæ­¥ï¼‰**:
```
internal/runner/
â”œâ”€â”€ orchestrator/
â”‚   â”œâ”€â”€ types.go       (56 lines)
â”‚   â”œâ”€â”€ base.go        (119 lines)
â”‚   â””â”€â”€ standard.go    (452 lines)
â”œâ”€â”€ message/
â”‚   â””â”€â”€ builder.go     (201 lines)
â””â”€â”€ runner.go          (2397 lines, æš‚æœªä¿®æ”¹)
```

### å…³é”®æŒ‡æ ‡
| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ |
|------|------|------|
| æ–°ç»„ä»¶è¡Œæ•° | 828 è¡Œ | - |
| æœ€å¤§æ–‡ä»¶è¡Œæ•° | 2397 (runner.go) | <800 |
| æ–°å¢æµ‹è¯•è¦†ç›–ç‡ | 0% (å¾…æ·»åŠ ) | >85% |
| æµ‹è¯•é€šè¿‡ç‡ | âœ… 100% | 100% |

---

## ğŸ”„ å½“å‰æ¶æ„çŠ¶æ€

### é‡æ„è¿›åº¦
```
[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 40% (é˜¶æ®µ 1-2 å®Œæˆ)
```

### ç»„ä»¶çŠ¶æ€
- âœ… **Orchestrator æ¥å£**: å·²å®šä¹‰
- âœ… **BaseOrchestrator**: å·²å®ç°
- âœ… **StandardOrchestrator**: å·²å®ç°ï¼ˆåŠŸèƒ½å®Œæ•´ï¼‰
- âœ… **MessageBuilder**: å·²å®ç°ï¼ˆæœªé›†æˆï¼‰
- â³ **ACPOrchestrator**: æœªå®ç°
- â³ **ToolExecutor**: ç®€åŒ–ç‰ˆå·²é›†æˆåœ¨ StandardOrchestrator ä¸­
- â³ **RetryPolicy**: é€»è¾‘å·²å®ç°ä½†æœªæŠ½è±¡ä¸ºç‹¬ç«‹ç»„ä»¶
- â³ **StopCondition**: æœªå®ç°
- âŒ **Runner é›†æˆ**: æœªå¼€å§‹

---

## ğŸš¨ é‡è¦è¯´æ˜

### å…¼å®¹æ€§ä¿è¯
âœ… **æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡**  
âœ… **æ²¡æœ‰ä¿®æ”¹ `runner.go` çš„å…¬å…± API**  
âœ… **æ–°ç»„ä»¶ç‹¬ç«‹ç¼–è¯‘é€šè¿‡**

### æ¶æ„å†³ç­–

#### 1. æ¸è¿›å¼é‡æ„ç­–ç•¥
- æ–°ç»„ä»¶å·²åˆ›å»ºä½†**å°šæœªé›†æˆ**åˆ° `Runner` ä¸­
- `runner.go` ä¿æŒä¸å˜ï¼Œç¡®ä¿ç°æœ‰åŠŸèƒ½ 100% å¯ç”¨
- åç»­é˜¶æ®µå°†é€æ­¥æ›¿æ¢ `runner.go` ä¸­çš„å†…è”é€»è¾‘ä¸ºæ–°ç»„ä»¶è°ƒç”¨

#### 2. StandardOrchestrator è®¾è®¡æƒè¡¡
**ä¿ç•™çš„åŠŸèƒ½**:
- å®Œæ•´çš„é‡è¯•é€»è¾‘ï¼ˆä¸Šä¸‹æ–‡çª—å£æº¢å‡ºã€ä¸´æ—¶é”™è¯¯ï¼‰
- å‹ç¼©åæ¨¡å¼åˆ‡æ¢ï¼ˆChat/Streamï¼‰
- MCP æ³¨å…¥æ¨¡å¼åˆ‡æ¢ï¼ˆFull/Summaryï¼‰
- å¿ƒè·³æœºåˆ¶ï¼ˆç®€åŒ–ç‰ˆï¼‰

**ç®€åŒ–çš„éƒ¨åˆ†**:
- å·¥å…·æ‰§è¡Œï¼šæš‚æ—¶ç›´æ¥è°ƒç”¨ `registry.Execute`ï¼Œæœªå®ç°ï¼š
  - Policy æ£€æŸ¥ï¼ˆå·²æœ‰æ¥å£ï¼Œæœªè°ƒç”¨ï¼‰
  - Approval æµç¨‹ï¼ˆå·²æœ‰æ¥å£ï¼Œæœªè°ƒç”¨ï¼‰
  - å®Œæ•´çš„é’©å­ï¼ˆbefore/after tool callï¼‰
  - ç»“æœæˆªæ–­ï¼ˆcompactionConfig.ToolResultMaxBytesï¼‰
- æ¶ˆæ¯æ„å»ºï¼šä½¿ç”¨ `buildMessagesLegacy`ï¼Œæœªé›†æˆ `MessageBuilder`

**åŸå› **: 
- ä¼˜å…ˆå®ç°æ ¸å¿ƒå¾ªç¯é€»è¾‘
- é¿å…ä¸€æ¬¡æ€§ä¿®æ”¹è¿‡å¤šå¯¼è‡´éš¾ä»¥è°ƒè¯•
- åç»­é˜¶æ®µé€æ­¥è¡¥å…¨

---

## ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œ

### é˜¶æ®µ 2: å®Œå–„ Orchestratorï¼ˆå‰©ä½™å·¥ä½œï¼‰

#### 2.2 å®ç° ACPOrchestrator
**ä¼˜å…ˆçº§**: P0ï¼ˆå¿…é¡»ï¼‰  
**é¢„ä¼°**: 2 å°æ—¶  
**ä»»åŠ¡**:
- åˆ›å»º `internal/runner/orchestrator/acp.go`
- å¤ç”¨ `runACPMode` é€»è¾‘ï¼ˆLines 1197-1428ï¼‰
- å…±äº« `BaseOrchestrator` çš„å‹ç¼©å’Œæ¶ˆæ¯æ„å»ºé€»è¾‘

#### 2.3 é›†æˆåˆ° Runner.Run()
**ä¼˜å…ˆçº§**: P0ï¼ˆå¿…é¡»ï¼‰  
**é¢„ä¼°**: 3 å°æ—¶  
**ä»»åŠ¡**:
- ä¿®æ”¹ `Runner.Run()` ä»¥ä½¿ç”¨æ–°çš„ Orchestrator
- åˆ›å»º Orchestrator å·¥å‚æ–¹æ³•ï¼ˆæ ¹æ® Provider ç±»å‹é€‰æ‹©ï¼‰
- åˆ é™¤æ—§çš„ `runLoop`, `runLoopCore`, `runACPMode` æ–¹æ³•
- **é¢„è®¡åˆ é™¤ä»£ç **: ~800 è¡Œ

#### 2.4 é›†æˆ MessageBuilder
**ä¼˜å…ˆçº§**: P1ï¼ˆé‡è¦ï¼‰  
**é¢„ä¼°**: 1 å°æ—¶  
**ä»»åŠ¡**:
- æ›¿æ¢ `StandardOrchestrator.buildMessagesLegacy`
- æ›¿æ¢ `ACPOrchestrator` ä¸­çš„æ¶ˆæ¯æ„å»ºé€»è¾‘
- åˆ é™¤ `runner.buildMessages` æ–¹æ³•
- **é¢„è®¡åˆ é™¤ä»£ç **: ~120 è¡Œ

### é˜¶æ®µ 3: ç§»é™¤é‡å¤ä»£ç 
**ä¼˜å…ˆçº§**: P0ï¼ˆå¿…é¡»ï¼‰  
**é¢„ä¼°**: 1 å°æ—¶  
**ä»»åŠ¡**:
- åˆ é™¤ `runLoopCore` (~430 è¡Œ)
- åˆ é™¤ `runACPMode` (~232 è¡Œ)
- åˆ é™¤ `buildMessages` (~120 è¡Œ)
- **æ€»è®¡åˆ é™¤**: ~782 è¡Œ

### é˜¶æ®µ 4: å®Œå–„åŠŸèƒ½
**ä¼˜å…ˆçº§**: P1ï¼ˆé‡è¦ï¼‰  
**é¢„ä¼°**: 4 å°æ—¶  
**ä»»åŠ¡**:
- åœ¨ `StandardOrchestrator` ä¸­é›†æˆå®Œæ•´çš„å·¥å…·æ‰§è¡Œé€»è¾‘:
  - Policy æ£€æŸ¥
  - Approval æµç¨‹
  - Tool hooks (before/after)
  - ç»“æœæˆªæ–­
- æå– RetryPolicy ä¸ºç‹¬ç«‹ç»„ä»¶ï¼ˆå¯é€‰ï¼‰
- æå– StopCondition ä¸ºç‹¬ç«‹ç»„ä»¶ï¼ˆå¯é€‰ï¼‰

### é˜¶æ®µ 5: æµ‹è¯•å’Œæ–‡æ¡£
**ä¼˜å…ˆçº§**: P0ï¼ˆå¿…é¡»ï¼‰  
**é¢„ä¼°**: 4 å°æ—¶  
**ä»»åŠ¡**:
- ä¸ºæ–°ç»„ä»¶æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆ85%+ è¦†ç›–ç‡ï¼‰
- åˆ›å»ºé›†æˆæµ‹è¯•
- æ›´æ–°æ¶æ„æ–‡æ¡£

---

## ğŸ¯ é¢„æœŸæœ€ç»ˆæ•ˆæœ

### æ–‡ä»¶ç»“æ„
```
internal/runner/
â”œâ”€â”€ runner.go              (~400 lines) â† ä» 2397 å‡å°‘åˆ° 400
â”œâ”€â”€ orchestrator/
â”‚   â”œâ”€â”€ types.go           (80 lines)
â”‚   â”œâ”€â”€ base.go            (150 lines)
â”‚   â”œâ”€â”€ standard.go        (500 lines)
â”‚   â”œâ”€â”€ acp.go             (250 lines)
â”‚   â”œâ”€â”€ factory.go         (50 lines)
â”‚   â””â”€â”€ orchestrator_test.go (200 lines)
â”œâ”€â”€ message/
â”‚   â”œâ”€â”€ builder.go         (200 lines)
â”‚   â””â”€â”€ builder_test.go    (150 lines)
â”œâ”€â”€ executor/              (å¯é€‰ï¼Œåç»­é˜¶æ®µ)
â”‚   â”œâ”€â”€ tool_executor.go   (300 lines)
â”‚   â””â”€â”€ executor_test.go   (200 lines)
â””â”€â”€ ...
```

### ä»£ç å‡å°‘
- **runner.go**: 2397 â†’ ~400 è¡Œ (-2000 è¡Œ, -83%)
- **é‡å¤ä»£ç **: ~662 è¡Œ â†’ 0 è¡Œ (-100%)
- **æœ€å¤§æ–¹æ³•é•¿åº¦**: 430 è¡Œ â†’ ~50 è¡Œ (-88%)

---

## âš ï¸ é£é™©è¯„ä¼°

### å·²ç¼“è§£çš„é£é™©
âœ… **åŠŸèƒ½ç ´å**: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæœªä¿®æ”¹ç°æœ‰ä»£ç   
âœ… **ç¼–è¯‘å¤±è´¥**: æ–°ç»„ä»¶ç‹¬ç«‹ç¼–è¯‘é€šè¿‡  
âœ… **æ€§èƒ½ä¸‹é™**: æœªå¼•å…¥é¢å¤–å†…å­˜åˆ†é…æˆ–åŒæ­¥

### å¾…å…³æ³¨çš„é£é™©
âš ï¸ **é›†æˆå¤æ‚åº¦**: é˜¶æ®µ 2.3ï¼ˆRunner.Run() é›†æˆï¼‰éœ€è¦ä»”ç»†æµ‹è¯•  
âš ï¸ **æµ‹è¯•è¦†ç›–**: æ–°ç»„ä»¶ç¼ºå°‘å•å…ƒæµ‹è¯•ï¼Œéœ€åœ¨é˜¶æ®µ 5 è¡¥å……  
âš ï¸ **è¾¹ç•Œæƒ…å†µ**: å·¥å…·æ‰§è¡Œç®€åŒ–ç‰ˆå¯èƒ½é—æ¼è¾¹ç•Œæƒ…å†µå¤„ç†

---

## ğŸ“ˆ è¿›åº¦è·Ÿè¸ª

### å®Œæˆæƒ…å†µ
- [x] é˜¶æ®µ 0: å‡†å¤‡å·¥ä½œ
- [x] é˜¶æ®µ 1.1: Orchestrator æ¥å£
- [x] é˜¶æ®µ 1.2: MessageBuilder
- [x] é˜¶æ®µ 1.3-2.1: StandardOrchestrator
- [ ] é˜¶æ®µ 2.2: ACPOrchestrator
- [ ] é˜¶æ®µ 2.3: Runner é›†æˆ
- [ ] é˜¶æ®µ 2.4: MessageBuilder é›†æˆ
- [ ] é˜¶æ®µ 3: ç§»é™¤é‡å¤ä»£ç 
- [ ] é˜¶æ®µ 4: å®Œå–„åŠŸèƒ½
- [ ] é˜¶æ®µ 5: æµ‹è¯•å’Œæ–‡æ¡£

### æ—¶é—´ä¼°ç®—
- **å·²å®Œæˆ**: 4 å°æ—¶
- **å‰©ä½™å·¥ä½œ**: 11 å°æ—¶
- **æ€»é¢„ä¼°**: 15 å°æ—¶

### å…³é”®é‡Œç¨‹ç¢‘
- âœ… **M1**: æ–°ç»„ä»¶åˆ›å»ºå®Œæˆï¼ˆå½“å‰ï¼‰
- â³ **M2**: Runner é›†æˆå®Œæˆï¼ˆé¢„è®¡ +3 å°æ—¶ï¼‰
- â³ **M3**: é‡å¤ä»£ç ç§»é™¤ï¼ˆé¢„è®¡ +4 å°æ—¶ï¼‰
- â³ **M4**: åŠŸèƒ½å®Œå–„å’Œæµ‹è¯•ï¼ˆé¢„è®¡ +8 å°æ—¶ï¼‰

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æˆåŠŸçš„åœ°æ–¹
1. **æ¸è¿›å¼é‡æ„**: æ–°ç»„ä»¶ç‹¬ç«‹åˆ›å»ºï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½
2. **æµ‹è¯•å…ˆè¡Œ**: ç¡®ä¿æµ‹è¯•åŸºçº¿å¹²å‡€ï¼ŒæŒç»­éªŒè¯
3. **æ¸…æ™°çš„è¾¹ç•Œ**: Orchestrator/MessageBuilder èŒè´£æ˜ç¡®
4. **ä»£ç å¤ç”¨**: BaseOrchestrator ä¸ºä¸åŒ Orchestrator æä¾›å…±äº«åŠŸèƒ½

### éœ€è¦æ”¹è¿›
1. **å•å…ƒæµ‹è¯•æ»å**: åº”è¯¥ä¸ç»„ä»¶åˆ›å»ºåŒæ­¥è¿›è¡Œ
2. **æ–‡æ¡£ä¸è¶³**: æ–°ç»„ä»¶ç¼ºå°‘è¯¦ç»†çš„ä»£ç æ³¨é‡Š
3. **å·¥å…·æ‰§è¡Œç®€åŒ–**: éœ€åœ¨åç»­é˜¶æ®µè¡¥å…¨å®Œæ•´åŠŸèƒ½

---

**ä¸‹æ¬¡é‡æ„ä¼šè¯å¼€å§‹æ—¶**ï¼Œè¯·ä»**é˜¶æ®µ 2.2ï¼ˆACPOrchestratorï¼‰**ç»§ç»­ã€‚

**ä½œè€…**: AI Assistant  
**å®¡æ ¸**: å¾…äººå·¥å®¡æ ¸
