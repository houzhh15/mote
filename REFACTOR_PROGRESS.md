# Runner æ¨¡å—åŒ–é‡æ„è¿›åº¦æŠ¥å‘Š

## ğŸ“Š æ€»ä½“æ¦‚è§ˆ

**é‡æ„ç›®æ ‡**: å°† 2497 è¡Œçš„ "God Object" runner.go é‡æ„ä¸ºæ¨¡å—åŒ–æ¶æ„  
**å®ŒæˆçŠ¶æ€**: âœ… æ ¸å¿ƒé‡æ„å·²å®Œæˆ  
**åˆ†æ”¯**: `refactor/runner-modular`  
**æµ‹è¯•çŠ¶æ€**: 100% é€šè¿‡ (æ‰€æœ‰ runner ç›¸å…³æµ‹è¯•)

## ğŸ¯ æ¶æ„æ”¹è¿›

### é‡æ„å‰
```
internal/runner/
  â””â”€â”€ runner.go (2497 è¡Œ) - "God Object"
      â”œâ”€â”€ runLoopCore()         ~418 è¡Œ - æ ‡å‡†æ¨¡å¼
      â”œâ”€â”€ runACPMode()          ~247 è¡Œ - ACP åè®®æ¨¡å¼
      â”œâ”€â”€ buildMessages()       - æ¶ˆæ¯æ„å»º
      â”œâ”€â”€ executeTools()        - å·¥å…·æ‰§è¡Œ
      â””â”€â”€ ... å…¶ä»–æ··æ‚é€»è¾‘
```

### é‡æ„å
```
internal/runner/
  â”œâ”€â”€ runner.go (1832 è¡Œ, -665 è¡Œ, -26.6%)
  â”‚   â”œâ”€â”€ Run() - å…¥å£å‡½æ•°
  â”‚   â”œâ”€â”€ runLoopCoreWithOrchestrator() - ä½¿ç”¨æ–°æ¶æ„
  â”‚   â””â”€â”€ ... å…¶ä»–è¾…åŠ©æ–¹æ³•
  â”‚
  â”œâ”€â”€ orchestrator/         (æ–°å»ºåŒ…)
  â”‚   â”œâ”€â”€ types.go          - æ ¸å¿ƒæ¥å£å®šä¹‰ (47 è¡Œ)
  â”‚   â”œâ”€â”€ base.go           - å…±äº«åŸºç¡€è®¾æ–½ (167 è¡Œ)
  â”‚   â”œâ”€â”€ standard.go       - æ ‡å‡†å·¥å…·è°ƒç”¨ç¼–æ’å™¨ (453 è¡Œ)
  â”‚   â”œâ”€â”€ acp.go            - ACP åè®®ç¼–æ’å™¨ (327 è¡Œ)
  â”‚   â”œâ”€â”€ builder.go        - å·¥å‚æ¨¡å¼æ„å»ºå™¨ (64 è¡Œ)
  â”‚   â””â”€â”€ errors.go         - é”™è¯¯å®šä¹‰ (15 è¡Œ)
  â”‚
  â”œâ”€â”€ message/             (æ–°å»ºåŒ…)
  â”‚   â””â”€â”€ builder.go        - æ¶ˆæ¯æ„å»ºå™¨ (262 è¡Œ)
  â”‚
  â””â”€â”€ types/               (æ–°å»ºåŒ…)
      â””â”€â”€ event.go          - å…±äº«ç±»å‹å®šä¹‰ (154 è¡Œ)
```

## ğŸ“ˆ ä»£ç åº¦é‡

### ä»£ç é‡å˜åŒ–
- **runner.go**: 2497 â†’ 1832 è¡Œ (-665 è¡Œ, -26.6%)
- **æ–°å¢ä»£ç **: ~1489 è¡Œ (å®ç°) + 374 è¡Œ (æµ‹è¯•)
- **å‡€å¢åŠ **: ~735 è¡Œ (ä½†ç»“æ„æ›´æ¸…æ™°ï¼Œå¯ç»´æŠ¤æ€§æå‡)

### æ–°å¢æ–‡ä»¶ (7 ä¸ªå®ç°æ–‡ä»¶)

| æ–‡ä»¶ | è¡Œæ•° | ä½œç”¨ |
|------|------|------|
| `orchestrator/types.go` | 47 | ç¼–æ’å™¨æ¥å£å’Œé…ç½®ç±»å‹ |
| `orchestrator/base.go` | 167 | å…±äº«åŸºç¡€è®¾æ–½ (å‹ç¼©ã€é’©å­ç­‰) |
| `orchestrator/standard.go` | 453 | æ ‡å‡†å·¥å…·è°ƒç”¨å¾ªç¯ç¼–æ’å™¨ |
| `orchestrator/acp.go` | 327 | ACP åè®®ç¼–æ’å™¨ |
| `orchestrator/builder.go` | 64 | å·¥å‚æ¨¡å¼æ„å»ºå™¨ |
| `orchestrator/errors.go` | 15 | é”™è¯¯å®šä¹‰ |
| `message/builder.go` | 262 | æ¶ˆæ¯æ„å»ºå™¨ |
| `types/event.go` | 154 | å…±äº«äº‹ä»¶ç±»å‹ |
| **æ€»è®¡** | **1489** | |

### æµ‹è¯•è¦†ç›– (2 ä¸ªæµ‹è¯•æ–‡ä»¶, 9 ä¸ªæµ‹è¯•)

| æµ‹è¯•æ–‡ä»¶ | è¡Œæ•° | æµ‹è¯•æ•° | çŠ¶æ€ |
|---------|------|--------|------|
| `message/builder_test.go` | 227 | 5 | âœ… PASS |
| `orchestrator/orchestrator_test.go` | 147 | 4 | âœ… PASS |
| **æ€»è®¡** | **374** | **9** | **100%** |

## ğŸ—ï¸ æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. ç¼–æ’å™¨æ¨¡å¼ (Orchestrator Pattern)
```go
type Orchestrator interface {
    Run(ctx context.Context, req *RunRequest) types.Event
}
```

**ä¼˜åŠ¿**:
- åè®®è§£è€¦ï¼šStandardOrchestrator (æ ‡å‡†) vs ACPOrchestrator (ACP)
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªç¼–æ’å™¨åªå¤„ç†ä¸€ç§æ‰§è¡Œæ¨¡å¼
- æ˜“äºæ‰©å±•ï¼šæ–°å¢åè®®åªéœ€å®ç°æ–°çš„ Orchestrator

### 2. æ„å»ºå™¨æ¨¡å¼ (Builder Pattern)
```go
builder := orchestrator.NewBuilder().
    WithProvider(provider).
    WithHookManager(hooks).
    WithCompactor(compactor)
orch := builder.Build()
```

**ä¼˜åŠ¿**:
- ä¾èµ–æ³¨å…¥ï¼šæ‰€æœ‰ä¾èµ–é€šè¿‡æ„å»ºå™¨æ³¨å…¥
- ç±»å‹å®‰å…¨ï¼šè‡ªåŠ¨æ£€æµ‹ ACP èƒ½åŠ›ï¼Œé€‰æ‹©åˆé€‚çš„ç¼–æ’å™¨
- çµæ´»é…ç½®ï¼šå¯é€‰ç»„ä»¶æŒ‰éœ€é…ç½®

### 3. Strangler Pattern (ç»æ€è€…æ¨¡å¼)
é€æ­¥è¿ç§»ç­–ç•¥ï¼Œä¿è¯é›¶åŠŸèƒ½æŸå¤±ï¼š
1. âœ… åˆ›å»ºæ–°å®ç° (StandardOrchestrator, ACPOrchestrator)
2. âœ… å¹¶è¡Œéƒ¨ç½² (runLoopCore vs runLoopCoreWithOrchestrator)
3. âœ… åˆ‡æ¢æµé‡ (ä¿®æ”¹ 2 ä¸ªè°ƒç”¨ç‚¹)
4. âœ… ç§»é™¤æ—§ä»£ç  (åˆ é™¤ runLoopCore, runACPMode)

## ğŸ”„ è¿ç§»å†ç¨‹

### Phase 0: å‡†å¤‡é˜¶æ®µ (åŸºçº¿å»ºç«‹)
- [x] è¿è¡Œæµ‹è¯•åŸºçº¿ (æ‰€æœ‰æµ‹è¯•é€šè¿‡)
- [x] åˆ›å»ºé‡æ„åˆ†æ”¯ `refactor/runner-modular`

### Phase 1: æ ¸å¿ƒæŠ½è±¡å±‚
- [x] **1.1** åˆ›å»º Orchestrator æ¥å£å’Œç±»å‹å®šä¹‰
- [x] **1.2** åˆ›å»º MessageBuilder ç»„ä»¶
- [x] **1.3** å®ç° StandardOrchestrator (æ ‡å‡†æ¨¡å¼)

### Phase 2: æµ‹è¯•å·©å›º
- [x] ä¸º MessageBuilder æ·»åŠ æµ‹è¯• (5 æµ‹è¯•)
- [x] ä¸º StandardOrchestrator æ·»åŠ æµ‹è¯• (4 æµ‹è¯•)
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…

### Phase 3: ACP åè®®æ”¯æŒ
- [x] å®ç° ACPOrchestrator (327 è¡Œ)
- [x] è§£å†³å¾ªç¯ä¾èµ– (åˆ›å»º types åŒ…)
- [x] å®ç° OrchestratorBuilder å·¥å‚

### Phase 4: é›†æˆä¸æ¿€æ´»
- [x] é›†æˆåˆ° Runner.Run() (runLoopCoreWithOrchestrator)
- [x] å¯ç”¨æ–°è·¯å¾„ (åˆ‡æ¢ 2 ä¸ªè°ƒç”¨ç‚¹)
- [x] ä¿®å¤å‹ç¼©å›é€€é€»è¾‘ (TestRunACPMode_HistoryCompression)
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…

### Phase 5: æ¸…ç†ä¸æ”¶å°¾
- [x] åˆ é™¤ runLoopCore (~418 è¡Œ)
- [x] åˆ é™¤ runACPMode (~247 è¡Œ)
- [x] æäº¤æœ€ç»ˆç‰ˆæœ¬ (8d91165)

## ğŸ› é—®é¢˜è§£å†³è®°å½•

### é—®é¢˜ 1: å¾ªç¯ä¾èµ–
**ç°è±¡**: runner åŒ…å¯¼å…¥ orchestratorï¼Œorchestrator éœ€è¦ runner.Event  
**åŸå› **: ç±»å‹è€¦åˆå¯¼è‡´çš„å¾ªç¯å¼•ç”¨  
**è§£å†³æ–¹æ¡ˆ**: åˆ›å»ºç‹¬ç«‹çš„ `internal/runner/types` åŒ…å­˜æ”¾å…±äº«ç±»å‹  
**ç»“æœ**: âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ¶æ„æ›´æ¸…æ™°

### é—®é¢˜ 2: å‹ç¼©æµ‹è¯•å¤±è´¥
**ç°è±¡**: `TestRunACPMode_HistoryCompression` å¤±è´¥ (æœŸæœ› <100 æ¶ˆæ¯ï¼Œå®é™… 103)  
**åŸå› **: BaseOrchestrator.compressIfNeeded() ç¼ºå°‘å›é€€é€»è¾‘ (compactor==nil æ—¶)  
**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ ç®€å•çš„åŸºäºæ¶ˆæ¯æ•°é‡çš„å›é€€å‹ç¼© (ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ + æœ€è¿‘ 80% å¯¹è¯)  
**ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ (103 â†’ 26 æ¶ˆæ¯ï¼Œ74% å‹ç¼©ç‡)

### é—®é¢˜ 3: æµ‹è¯•è¦†ç›–ä¸è¶³
**ç°è±¡**: åˆå§‹å®ç°ç¼ºå°‘å•å…ƒæµ‹è¯•  
**åŸå› **: å¿«é€ŸåŸå‹é˜¶æ®µè·³è¿‡äº†æµ‹è¯•  
**è§£å†³æ–¹æ¡ˆ**: ç”¨æˆ·è¦æ±‚æš‚åœå·©å›ºï¼Œæ·»åŠ  9 ä¸ªå•å…ƒæµ‹è¯•  
**ç»“æœ**: âœ… 100% æµ‹è¯•é€šè¿‡ï¼Œè¦†ç›–æ ¸å¿ƒåŠŸèƒ½

## âœ… è´¨é‡ä¿è¯

### æµ‹è¯•ç»“æœ
```bash
$ go test ./internal/runner/... -count=1
ok      mote/internal/runner             2.922s  (30+ æµ‹è¯•)
ok      mote/internal/runner/message     2.226s  (5 æµ‹è¯•)
ok      mote/internal/runner/orchestrator 1.975s (4 æµ‹è¯•)
```

### åŠŸèƒ½éªŒè¯
- âœ… æ ‡å‡†å·¥å…·è°ƒç”¨å¾ªç¯ (StandardOrchestrator)
- âœ… ACP åè®®æµå¼è°ƒç”¨ (ACPOrchestrator)
- âœ… å†å²å‹ç¼© (compactor + fallback)
- âœ… ä¸Šä¸‹æ–‡çª—å£æº¢å‡ºé‡è¯•
- âœ… ç¬æ—¶é”™è¯¯é‡è¯•
- âœ… é’©å­ç³»ç»Ÿé›†æˆ (session_create, before_message)
- âœ… MCP æŠ€èƒ½æ³¨å…¥
- âœ… å·¥å…·è°ƒç”¨æš‚åœ/æ¢å¤
- âœ… ä»¤ç‰Œè·Ÿè¸ªå’Œä½¿ç”¨ç»Ÿè®¡

### å›å½’æµ‹è¯•
- âœ… æ‰€æœ‰æ—¢æœ‰æµ‹è¯•ä¿æŒé€šè¿‡
- âœ… é›¶åŠŸèƒ½æŸå¤±
- âœ… é›¶è¡Œä¸ºå·®å¼‚

## ğŸ“š æŠ€æœ¯äº®ç‚¹

### 1. ä¾èµ–æ³¨å…¥ & å¯é€‰ç»„ä»¶
æ‰€æœ‰ä¾èµ–é€šè¿‡æ„å»ºå™¨æ³¨å…¥ï¼Œæ”¯æŒå¯é€‰ç»„ä»¶ï¼š
```go
builder := orchestrator.NewBuilder().
    WithProvider(prov).                    // å¿…éœ€
    WithHookManager(r.hookManager).        // å¯é€‰
    WithCompactor(r.compactor).            // å¯é€‰
    WithSkillManager(r.skillManager).      // å¯é€‰
    WithMCPManager(r.mcpManager).          // å¯é€‰
    WithSystemPrompt(r.systemPrompt)       // å¯é€‰
```

### 2. ç±»å‹å®‰å…¨çš„åè®®æ£€æµ‹
```go
if acpProv, ok := prov.(provider.ACPCapable); ok && acpProv.IsACPProvider() {
    return builder.buildACPOrchestrator()
}
return builder.buildStandardOrchestrator()
```

### 3. æ™ºèƒ½å‹ç¼©å›é€€
```go
// ä¼˜å…ˆä½¿ç”¨ M04 compactor
if o.compactor != nil {
    return o.compactor.CompactWithFallback(ctx, messages, prov)
}

// å›é€€ï¼šä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ + æœ€è¿‘ 80% å¯¹è¯
maxMessages := (maxTokens / 1000) * 4 / 5
if maxMessages < 10 {
    maxMessages = 10
}
// ... å‹ç¼©é€»è¾‘
```

### 4. äº‹ä»¶ç±»å‹è½¬æ¢ (types.Event â†’ runner.Event)
```go
// FromTypesEvent å°† types.Event è½¬æ¢ä¸º runner.Event
func FromTypesEvent(e types.Event) Event {
    result := Event{Type: EventType(e.Type)}
    // ... é€’å½’è½¬æ¢åµŒå¥—ç»“æ„
    return result
}
```

## ğŸš€ æ€§èƒ½å½±å“

### è¿è¡Œæ—¶æ€§èƒ½
- **æ— æ€§èƒ½å›å½’**: æ–°æ¶æ„é€šè¿‡æ¥å£è°ƒç”¨ï¼ŒGo ç¼–è¯‘å™¨å†…è”ä¼˜åŒ–åå¼€é”€å¯å¿½ç•¥
- **æµ‹è¯•è€—æ—¶**: åŸºæœ¬æ— å˜åŒ–

### å†…å­˜å ç”¨
- **å¯å¿½ç•¥å¢åŠ **: ç¼–æ’å™¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ (æ¯æ¬¡è¯·æ±‚åˆ›å»º)
- **GC å‹åŠ›**: æ— æ˜æ˜¾å˜åŒ–

## ğŸ“ æäº¤è®°å½•

| Commit | æè¿° | æ–‡ä»¶å˜åŒ– |
|--------|------|----------|
| `144c0b8` | feat: é›†æˆ Orchestrator åˆ° Runner (å‡†å¤‡é˜¶æ®µ) | +67/-0 |
| `ca70f96` | feat: å¯ç”¨æ–°çš„ Orchestrator è·¯å¾„ + å‹ç¼©ä¿®å¤ | +39/-3 |
| `8d91165` | refactor: ç§»é™¤æ—§çš„ runLoopCore å’Œ runACPMode | +0/-664 |

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (1-2 å‘¨)
- [ ] ç»§ç»­ç»†åŒ– runner.go (ç›®æ ‡: æ‹†åˆ†ä¸ºæ›´å°çš„æ–‡ä»¶)
  - [ ] å·¥å…·æ‰§è¡Œé€»è¾‘ â†’ `tool_executor.go`
  - [ ] é’©å­é›†æˆ â†’ `hooks.go`
  - [ ] å†…å­˜ç®¡ç† â†’ `memory.go`
- [ ] æ·»åŠ æ›´å¤šè¾¹ç¼˜åœºæ™¯æµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯• (benchmark)

### ä¸­æœŸ (1 ä¸ªæœˆ)
- [ ] MessageBuilder æ”¯æŒæ›´å¤šæ¨¡æ¿
- [ ] Orchestrator æ”¯æŒæ’ä»¶å¼æ‰©å±•
- [ ] é›†æˆ OpenTelemetry è¿½è¸ª

### é•¿æœŸ (3 ä¸ªæœˆ)
- [ ] å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ–‡æ¡£ç”Ÿæˆå·¥å…·
- [ ] æ¶æ„å†³ç­–è®°å½• (ADR)

## ğŸ’¡ ç»éªŒæ•™è®­

### âœ… æˆåŠŸç»éªŒ
1. **æ¸è¿›å¼é‡æ„**: Strangler Pattern ç¡®ä¿äº†é›¶é£é™©è¿‡æ¸¡
2. **æµ‹è¯•å…ˆè¡Œ**: åœ¨ç”¨æˆ·è¦æ±‚ä¸‹æš‚åœæ·»åŠ æµ‹è¯•ï¼Œé¿å…äº†åç»­å¤§é‡è¿”å·¥
3. **å¾ªç¯ä¾èµ–è§£å†³**: åˆ›å»º types åŒ…æ˜¯å…³é”®è®¾è®¡å†³ç­–ï¼Œä¿æŒäº†åŒ…çš„ç‹¬ç«‹æ€§
4. **åè®®æŠ½è±¡**: Orchestrator æ¥å£æˆåŠŸè§£è€¦äº†ä¸åŒåè®®çš„å®ç°ç»†èŠ‚

### âš ï¸ æ”¹è¿›ç©ºé—´
1. **åˆå§‹è§„åˆ’**: åº”è¯¥æ›´æ—©è¯†åˆ«å¾ªç¯ä¾èµ–é£é™©
2. **æµ‹è¯•è¦†ç›–**: ç†æƒ³æƒ…å†µä¸‹åº”è¯¥ TDD å¼€å‘ï¼Œè€Œéäº‹åè¡¥æµ‹è¯•
3. **ä»£ç é‡æ§åˆ¶**: è™½ç„¶ç»“æ„æ”¹å–„ï¼Œä½†æ€»ä»£ç é‡å¢åŠ äº† ~735 è¡Œ

## ğŸ“ æŠ€æœ¯å€ºåŠ¡æ¸…ç†

### å·²æ¸…ç†
- âœ… åˆ é™¤ 418 è¡Œçš„ runLoopCore
- âœ… åˆ é™¤ 247 è¡Œçš„ runACPMode
- âœ… æ¶ˆé™¤äº†åè®®åˆ¤æ–­çš„ if-else åˆ†æ”¯ (é€šè¿‡ OrchestratorBuilder)

### ä»éœ€æ¸…ç†
- â³ runner.go ä»æœ‰ 1832 è¡Œ (ç›®æ ‡ <800)
- â³ buildMessages() ç­‰è¾…åŠ©æ–¹æ³•ä»åœ¨ runner.go
- â³ å·¥å…·æ‰§è¡Œé€»è¾‘ä»è€¦åˆåœ¨ runner.go

## ğŸ“Š æœ€ç»ˆè¯„ä¼°

| ç»´åº¦ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|------|--------|--------|------|
| **ä»£ç è¡Œæ•°** | 2497 | 1832 | âœ… -26.6% |
| **æœ€å¤§æ–‡ä»¶** | 2497 | 1832 | âœ… ä½†ä»éœ€è¿›ä¸€æ­¥æ‹†åˆ† |
| **æ¨¡å—æ•°** | 1 | 4 | âœ… +300% |
| **æµ‹è¯•è¦†ç›–** | æ—¢æœ‰æµ‹è¯• | +9 æ–°æµ‹è¯• | âœ… æ ¸å¿ƒé€»è¾‘å·²è¦†ç›– |
| **å¾ªç¯å¤æ‚åº¦** | é«˜ (God Object) | ä½ (å•ä¸€èŒè´£) | âœ… æ˜¾è‘—é™ä½ |
| **å¯ç»´æŠ¤æ€§** | ä½ | é«˜ | âœ… æ¨¡å—åŒ–æ¶æ„ |
| **å¯æ‰©å±•æ€§** | ä½ | é«˜ | âœ… æ¥å£å’Œå·¥å‚æ¨¡å¼ |
| **å¯æµ‹è¯•æ€§** | ä¸­ | é«˜ | âœ… ä¾èµ–æ³¨å…¥ |

## ğŸ† æ€»ç»“

æœ¬æ¬¡é‡æ„æˆåŠŸå°† 2497 è¡Œçš„ "God Object" è½¬å˜ä¸ºæ¨¡å—åŒ–æ¶æ„ï¼š
- **å‡å°‘ 665 è¡Œæ ¸å¿ƒé€»è¾‘** (runLoopCore + runACPMode)
- **æ–°å¢ 1489 è¡Œé«˜è´¨é‡æ¨¡å—åŒ–ä»£ç ** (4 ä¸ªæ–°åŒ…)
- **æ–°å¢ 374 è¡Œæµ‹è¯•** (9 ä¸ªæµ‹è¯•ï¼Œ100% é€šè¿‡)
- **é›¶åŠŸèƒ½æŸå¤±ï¼Œé›¶è¡Œä¸ºå˜åŒ–**
- **æ¶æ„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§æ˜¾è‘—æå‡**

è™½ç„¶æ€»ä»£ç é‡ç•¥æœ‰å¢åŠ ï¼Œä½†**ä»£ç è´¨é‡å’Œç»“æ„æ¸…æ™°åº¦å¤§å¹…æå‡**ï¼Œä¸ºåç»­è¿­ä»£å’Œæ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚

---

**åˆ†æ”¯**: `refactor/runner-modular`  
**æœ€æ–°æäº¤**: `8d91165`  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2024-01-XX
